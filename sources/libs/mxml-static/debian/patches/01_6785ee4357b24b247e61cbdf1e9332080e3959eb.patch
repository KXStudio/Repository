From 6785ee4357b24b247e61cbdf1e9332080e3959eb Mon Sep 17 00:00:00 2001
From: Michael R Sweet <michael.r.sweet@gmail.com>
Date: Tue, 14 Dec 2021 21:23:35 -0500
Subject: [PATCH] Fix POSIX thread cleanup code - _mxml_fini shouldn't be
 calling the global destructor, just deleting the per-thread key.

Bump version to 3.3.1.
---
 CHANGES.md     |  6 ++++++
 configure      | 20 ++++++++++----------
 configure.ac   |  2 +-
 mxml-private.c |  6 ------
 vcnet/config.h |  2 +-
 xcode/config.h |  2 +-
 6 files changed, 19 insertions(+), 19 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 964a51c..2c5d532 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,3 +1,9 @@
+# Changes in Mini-XML 3.3.1
+
+- Fixed a POSIX thread cleanup bug on macOS - per-thread data destructor called
+  twice.
+
+
 # Changes in Mini-XML 3.3
 
 - Cleaned up usage of `free` throughout the library (Issue #276)
diff --git a/configure b/configure
index 88f2afc..9ef9427 100755
--- a/configure
+++ b/configure
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.71 for Mini-XML 3.3.
+# Generated by GNU Autoconf 2.71 for Mini-XML 3.3.1.
 #
 # Report bugs to <https://github.com/michaelrsweet/mxml/issues>.
 #
@@ -610,8 +610,8 @@ MAKEFLAGS=
 # Identity of this package.
 PACKAGE_NAME='Mini-XML'
 PACKAGE_TARNAME='mxml'
-PACKAGE_VERSION='3.3'
-PACKAGE_STRING='Mini-XML 3.3'
+PACKAGE_VERSION='3.3.1'
+PACKAGE_STRING='Mini-XML 3.3.1'
 PACKAGE_BUGREPORT='https://github.com/michaelrsweet/mxml/issues'
 PACKAGE_URL='https://www.msweet.org/mxml'
 
@@ -1301,7 +1301,7 @@ if test "$ac_init_help" = "long"; then
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
   cat <<_ACEOF
-\`configure' configures Mini-XML 3.3 to adapt to many kinds of systems.
+\`configure' configures Mini-XML 3.3.1 to adapt to many kinds of systems.
 
 Usage: $0 [OPTION]... [VAR=VALUE]...
 
@@ -1367,7 +1367,7 @@ fi
 
 if test -n "$ac_init_help"; then
   case $ac_init_help in
-     short | recursive ) echo "Configuration of Mini-XML 3.3:";;
+     short | recursive ) echo "Configuration of Mini-XML 3.3.1:";;
    esac
   cat <<\_ACEOF
 
@@ -1470,7 +1470,7 @@ fi
 test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
-Mini-XML configure 3.3
+Mini-XML configure 3.3.1
 generated by GNU Autoconf 2.71
 
 Copyright (C) 2021 Free Software Foundation, Inc.
@@ -1770,7 +1770,7 @@ cat >config.log <<_ACEOF
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
-It was created by Mini-XML $as_me 3.3, which was
+It was created by Mini-XML $as_me 3.3.1, which was
 generated by GNU Autoconf 2.71.  Invocation command line was
 
   $ $0$ac_configure_args_raw
@@ -2831,7 +2831,7 @@ ac_config_headers="$ac_config_headers config.h"
 
 
 
-VERSION="3.3"
+VERSION="3.3.1"
 
 printf "%s\n" "#define MXML_VERSION \"Mini-XML v$VERSION\"" >>confdefs.h
 
@@ -6012,7 +6012,7 @@ cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 # report actual input values of CONFIG_FILES etc. instead of their
 # values after options handling.
 ac_log="
-This file was extended by Mini-XML $as_me 3.3, which was
+This file was extended by Mini-XML $as_me 3.3.1, which was
 generated by GNU Autoconf 2.71.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
@@ -6077,7 +6077,7 @@ ac_cs_config_escaped=`printf "%s\n" "$ac_cs_config" | sed "s/^ //; s/'/'\\\\\\\\
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 ac_cs_config='$ac_cs_config_escaped'
 ac_cs_version="\\
-Mini-XML config.status 3.3
+Mini-XML config.status 3.3.1
 configured by $0, generated by GNU Autoconf 2.71,
   with options \\"\$ac_cs_config\\"
 
diff --git a/configure.ac b/configure.ac
index 633a2e3..1b4b3ae 100644
--- a/configure.ac
+++ b/configure.ac
@@ -14,7 +14,7 @@ AC_PREREQ([2.70])
 
 
 dnl Package name and version...
-AC_INIT([Mini-XML], [3.3], [https://github.com/michaelrsweet/mxml/issues], [mxml], [https://www.msweet.org/mxml])
+AC_INIT([Mini-XML], [3.3.1], [https://github.com/michaelrsweet/mxml/issues], [mxml], [https://www.msweet.org/mxml])
 
 
 dnl This line is provided to ensure that you don't run the autoheader program
diff --git a/mxml-private.c b/mxml-private.c
index 8c1c58d..3f3ab6c 100644
--- a/mxml-private.c
+++ b/mxml-private.c
@@ -165,12 +165,6 @@ _mxml_destructor(void *g)		/* I - Global data */
 static void
 _MXML_FINI(void)
 {
-  _mxml_global_t	*global;	/* Global data */
-
-
-  if ((global = (_mxml_global_t *)pthread_getspecific(_mxml_key)) != NULL)
-    _mxml_destructor(global);
-
   pthread_key_delete(_mxml_key);
 }
 
diff --git a/vcnet/config.h b/vcnet/config.h
index 9fd99ed..bf9207c 100644
--- a/vcnet/config.h
+++ b/vcnet/config.h
@@ -63,7 +63,7 @@
  * Version number...
  */
 
-#define MXML_VERSION "Mini-XML v3.3"
+#define MXML_VERSION "Mini-XML v3.3.1"
 
 
 /*
diff --git a/xcode/config.h b/xcode/config.h
index d627820..4cb3556 100644
--- a/xcode/config.h
+++ b/xcode/config.h
@@ -24,7 +24,7 @@
  * Version number...
  */
 
-#define MXML_VERSION "Mini-XML v3.3"
+#define MXML_VERSION "Mini-XML v3.3.1"
 
 
 /*
